(function(d){d.TextboxList=function(i,u){var x,q,D,v,o=false,l=[],F,g={};var j=d.extend(true,{prefix:"textboxlist",max:null,unique:false,uniqueInsensitive:true,endEditableBit:true,startEditableBit:true,hideEditableBits:true,inBetweenEditableBits:true,keys:{previous:37,next:39},bitsOptions:{editable:{},box:{}},plugins:{},encode:function(I){return d.grep(d.map(I,function(J){J=(a(J[0])?J[0]:J[1]);return a(J)?J.toString().replace(/,/,""):null}),function(J){return J!=undefined}).join(",")},decode:function(I){return I.split(",")}},u);i=d(i);var t=this;var A=function(){x=i.css("display","none").attr("autocomplete","off").focus(h);q=d('<div class="'+j.prefix+'" />').insertAfter(i).click(function(J){if((J.target==D.get(0)||J.target==q.get(0))&&(!o||(v&&v.toElement().get(0)!=D.find(":last-child").get(0)))){h()}});D=d('<ul class="'+j.prefix+'-bits" />').appendTo(q);for(var I in j.plugins){m(I,j.plugins[I])}C()};var m=function(J,I){t.plugins[J]=new d.TextboxList[c(b(J))](t,I)};var C=function(){if(j.endEditableBit){p("editable",null,{tabIndex:x.tabIndex}).inject(D)}w("bitAdd",n,true);w("bitRemove",n,true);d(document).click(function(J){if(!o){return}if(J.target.className.indexOf(j.prefix)!=-1){if(J.target==d(q).get(0)){return}var I=d(J.target).parents("div."+j.prefix);if(I.get(0)==q.get(0)){return}}y()}).keydown(function(K){if(!o||!v){return}var N=v.is("editable")?v.getCaret():null;var M=v.getValue()[1];var I=!!d.map(["shift","alt","meta","ctrl"],function(O){return K[O]}).length;var L=I||(v.is("editable")&&v.isSelected());var J=function(){K.stopPropagation();K.preventDefault()};switch(K.which){case 8:if(v.is("box")){J();return v.remove()}case j.keys.previous:if(v.is("box")||((N==0||!M.length)&&!L)){J();k("prev")}break;case 46:if(v.is("box")){J();return v.remove()}case j.keys.next:if(v.is("box")||(N==M.length&&!L)){J();k("next")}}});B(j.decode(x.val()))};var p=function(I,K,J){if(I=="box"){if(a(j.max)&&D.children("."+j.prefix+"-bit-box").length+1>j.max){return false}if(j.unique&&d.inArray(r(K),l)!=-1){return false}}return new d.TextboxListBit(I,K,t,d.extend(true,j.bitsOptions[I],J))};var r=function(I){return a(I[0])?I[0]:(j.uniqueInsensitive?I[1].toLowerCase():I[1])};var s=function(K,M,J,L){var I=p("box",[M,K,J]);if(I){if(!L||!L.length){L=D.find("."+j.prefix+"-bit-box").filter(":last")}I.inject(L.length?L:D,L.length?"after":"top")}return t};var k=function(J,L){var K=G(L&&d(L).length?L:v).toElement();var I=G(K[J]());if(I){I.focus()}return t};var h=function(){var I=D.children().filter(":last");if(I){G(I).focus()}return t};var y=function(){if(!o){return t}if(v){v.blur()}o=false;return H("blur")};var G=function(I){return(I.type&&(I.type=="editable"||I.type=="box"))?I:d(I).data("textboxlist:bit")};var f=function(){var I=[];D.children().each(function(){var J=G(this);if(!J.is("editable")){I.push(J.getValue())}});return I};var B=function(I){if(!I){return}d.each(I,function(K,J){if(J){s.apply(t,d.isArray(J)?[J[1],J[0],J[2]]:[J])}})};var n=function(){x.val(j.encode(f()))};var w=function(J,I){if(g[J]==undefined){g[J]=[]}var K=false;d.each(g[J],function(L){if(L===I){K=true;return}});if(!K){g[J].push(I)}return t};var H=function(K,J,I){if(!g||!g[K]){return t}d.each(g[K],function(L,M){(function(){J=(J!=undefined)?e(J):Array.prototype.slice.call(arguments);var N=function(){return M.apply(t||null,J)};if(I){return setTimeout(N,I)}return N()})()});return t};var z=function(K,J){if(g[K]){for(var I=g[K].length;I--;I){if(g[K][I]===J){g[K].splice(I,1)}}}return t};var E=function(I){return d.inArray(r(I),l)};this.onFocus=function(I){if(v){v.blur()}clearTimeout(F);v=I;q.addClass(j.prefix+"-focus");if(!o){o=true;H("focus",I)}};this.onAdd=function(L){if(j.unique&&L.is("box")){l.push(r(L.getValue()))}if(L.is("box")){var J=G(L.toElement().prev());if((J&&J.is("box")&&j.inBetweenEditableBits)||(!J&&j.startEditableBit)){var K=J&&J.toElement().length?J.toElement():false;var I=p("editable").inject(K||D,K?"after":"top");if(j.hideEditableBits){I.hide()}}}};this.onRemove=function(K){if(!o){return}if(j.unique&&K.is("box")){var I=E(K.getValue());if(I!=-1){l=l.splice(I+1,1)}}var J=G(K.toElement().prev());if(J&&J.is("editable")){J.remove()}k("next",K)};this.onBlur=function(J,I){v=null;q.removeClass(j.prefix+"-focus");F=setTimeout(y,I?0:200)};this.setOptions=function(I){j=d.extend(true,j,I)};this.getOptions=function(){return j};this.getContainer=function(){return q};this.isDuplicate=E;this.addEvent=w;this.removeEvent=z;this.fireEvent=H;this.create=p;this.add=s;this.getValues=f;this.plugins=[];A()};d.TextboxListBit=function(h,r,y,q){var f,l,t,i,m,v,j=false,B=b(h);var g=d.extend(true,h=="box"?{deleteButton:true}:{tabIndex:null,growing:true,growingOptions:{},stopEnter:true,addOnBlur:false,addKeys:[13]},q);this.type=h;this.value=r;var n=this;var u=function(){t=y.getOptions().prefix+"-bit";i=t+"-"+h;l=d("<li />").addClass(t).addClass(i).data("textboxlist:bit",n).hover(function(){l.addClass(t+"-hover").addClass(i+"-hover")},function(){l.removeClass(t+"-hover").removeClass(i+"-hover")});if(h=="box"){l.html(a(n.value[2])?n.value[2]:n.value[1]).click(o);if(g.deleteButton){l.addClass(i+"-deletable");m=d('<a href="#" class="'+i+'-deletebutton" />').click(A).appendTo(l)}l.children().click(function(C){C.stopPropagation();C.preventDefault()})}else{f=d('<input type="text" class="'+i+'-input" autocomplete="off" />').val(n.value?n.value[1]:"").appendTo(l);if(a(g.tabIndex)){f.tabIndex=g.tabIndex}if(g.growing){new d.GrowingInput(f,g.growingOptions)}f.focus(function(){o(true)}).blur(function(){s(true);if(g.addOnBlur){w()}});if(g.addKeys||g.stopEnter){f.keydown(function(D){if(!j){return}var C=function(){D.stopPropagation();D.preventDefault()};if(g.stopEnter&&D.which===13){C()}if(d.inArray(D.which,e(g.addKeys))!=-1){C();w()}})}}};var p=function(D,C){switch(C||"bottom"){case"top":l.prependTo(D);break;case"bottom":l.appendTo(D);break;case"before":l.insertBefore(D);break;case"after":l.insertAfter(D);break}y.onAdd(n);return x("add")};var o=function(C){if(j){return n}z();j=true;y.onFocus(n);l.addClass(t+"-focus").addClass(t+"-"+h+"-focus");x("focus");if(h=="editable"&&!C){f.focus()}return n};var s=function(C){if(!j){return n}j=false;y.onBlur(n);l.removeClass(t+"-focus").removeClass(t+"-"+h+"-focus");x("blur");if(h=="editable"){if(!C){f.blur()}if(v&&!f.val().length){k()}}return n};var A=function(){s();y.onRemove(n);l.remove();return x("remove")};var z=function(){l.css("display","block");return n};var k=function(){l.css("display","none");v=true;return n};var x=function(C){C=b(C);y.fireEvent("bit"+C,n).fireEvent("bit"+B+C,n);return n};this.is=function(C){return h==C};this.setValue=function(C){if(h=="editable"){f.val(a(C[0])?C[0]:C[1]);if(g.growing){f.data("growing").resize()}}else{r=C}return n};this.getValue=function(){return h=="editable"?[null,f.val(),null]:r};if(h=="editable"){this.getCaret=function(){var C=f.get(0);if(C.createTextRange){var D=document.selection.createRange().duplicate();D.moveEnd("character",C.value.length);if(D.text===""){return C.value.length}return C.value.lastIndexOf(D.text)}else{return C.selectionStart}};this.getCaretEnd=function(){var C=f.get(0);if(C.createTextRange){var D=document.selection.createRange().duplicate();D.moveStart("character",-C.value.length);return D.text.length}else{return C.selectionEnd}};this.isSelected=function(){return j&&(n.getCaret()!==n.getCaretEnd())};var w=function(){var D=n.getValue();var C=y.create("box",D);if(C){C.inject(l,"before");n.setValue([null,"",null]);return C}return null};this.toBox=w}this.toElement=function(){return l};this.focus=o;this.blur=s;this.remove=A;this.inject=p;this.show=z;this.hide=k;this.fireBitEvent=x;u()};var a=function(f){return !!(f||f===0)};var e=function(f){return d.isArray(f)?f:[f]};var c=function(f){return f.replace(/-\D/g,function(g){return g.charAt(1).toUpperCase()})};var b=function(f){return f.replace(/\b[a-z]/g,function(g){return g.toUpperCase()})};d.fn.extend({textboxlist:function(f){return this.each(function(){new d.TextboxList(this,f)})}})})(jQuery);
